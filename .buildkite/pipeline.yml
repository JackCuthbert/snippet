env:
  SEGMENT_CONTEXTS: "snyk,npm,aws-credentials,ecr"
steps:
  - label: ":hammer: Build Dev Dependencies"
    command:
      - npm config set "//registry.npmjs.org/:_authToken" $${NPM_TOKEN}
      - make install
    plugins:
      - ssh://git@github.com/segmentio/cache-buildkite-plugin#v1.0.0:
          key: "v1-cache-dev-{{ checksum 'package-lock.json' }}"
          paths: ["node_modules/"]
      - docker#v3.3.0:
          image: node:10.16.3
          environment:
            - NPM_TOKEN

  - wait: ~

  - label: ":clippy: Test"
    commands:
      - make test
      - yarn codecov
    artifact_paths:
      - "coverage/**/*"
    plugins:
      - ssh://git@github.com/segmentio/cache-buildkite-plugin#v1.0.0:
          key: "v1-cache-dev-{{ checksum 'package-lock.json' }}"
          paths: ["node_modules/"]
      - docker#v3.3.0:
          image: node:10.16.3

  - label: ":lock: Check Prod Dependencies"
    command:
      - buildkite-agent artifact download dist/* .
      - npm config set "//registry.npmjs.org/:_authToken" $${NPM_TOKEN}
      - yarn install --frozen-lockfile --production
      - node -e "require('./dist/boot'); process.exit(0)"
    plugins:
      - ssh://git@github.com/segmentio/cache-buildkite-plugin#v1.0.0:
          key: "v1-cache-prod-{{ checksum 'package-lock.json' }}"
          paths: ["node_modules/"]
      - ssh://git@github.com/segmentio/snyk-buildkite-plugin#v1.0.0:
          runtime: npm
      - docker#v3.3.0:
          image: node:10.16.3
          environment:
            - NPM_TOKEN
            - AWS_REGION
            - AWS_DEFAULT_REGION
            - AWS_ACCESS_KEY_ID
            - AWS_SECRET_ACCESS_KEY
            - AWS_SESSION_TOKEN

  - wait: ~

  - label: ":hammer: Docker Build"
    branches: master staging
    command:
      - buildkite-agent artifact download dist/* .
      - docker build -t $${TREB_IMAGE_TAG} .
      - docker tag $${TREB_IMAGE_TAG} $${TREB_SHORT_IMAGE_TAG}
      - docker push $${TREB_IMAGE_TAG}
    plugins:
      - ssh://git@github.com/segmentio/cache-buildkite-plugin#v1.0.0:
          key: "v1-cache-prod-{{ checksum 'package-lock.json' }}"
          paths: ["node_modules/"]
